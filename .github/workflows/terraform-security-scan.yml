name: Terraform Security Scan

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'security/**'
      - '.github/workflows/terraform-security-scan.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'security/**'
      - '.github/workflows/terraform-security-scan.yml'
  workflow_dispatch:
    inputs:
      skip_checkov:
        description: 'Skip Checkov scan'
        required: false
        default: false
        type: boolean
      skip_tfsec:
        description: 'Skip TFSec scan'
        required: false
        default: false
        type: boolean
      skip_terrascan:
        description: 'Skip Terrascan scan'
        required: false
        default: false
        type: boolean
      fail_on_high:
        description: 'Fail build on high severity issues'
        required: false
        default: true
        type: boolean

env:
  TERRAFORM_VERSION: '1.5.7'
  CHECKOV_VERSION: '3.0.0'
  TFSEC_VERSION: '1.28.0'
  TERRASCAN_VERSION: '1.18.0'

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        
    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive src/
      continue-on-error: true
      
    - name: Terraform Init
      id: init
      run: |
        cd src
        terraform init -backend=false
        
    - name: Terraform Validate
      id: validate
      run: |
        cd src
        terraform validate
        
    - name: Comment PR - Terraform Validation
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
          #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
          
          <details><summary>Validation Output</summary>
          
          \`\`\`\n
          ${{ steps.validate.outputs.stdout }}
          \`\`\`
          
          </details>
          
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Create reports directory
      run: mkdir -p security/reports
      
    - name: Install Checkov
      if: ${{ !inputs.skip_checkov }}
      run: |
        pip install checkov==${{ env.CHECKOV_VERSION }}
        checkov --version
        
    - name: Install TFSec
      if: ${{ !inputs.skip_tfsec }}
      run: |
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        sudo mv tfsec /usr/local/bin/
        tfsec --version
        
    - name: Install Terrascan
      if: ${{ !inputs.skip_terrascan }}
      run: |
        curl -L "$(curl -s https://api.github.com/repos/tenable/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > terrascan.tar.gz
        tar -xf terrascan.tar.gz terrascan && rm terrascan.tar.gz
        sudo mv terrascan /usr/local/bin/
        terrascan version
        
    - name: Run Checkov Security Scan
      if: ${{ !inputs.skip_checkov }}
      continue-on-error: true
      run: |
        checkov \
          --config-file security/sast-tools/.checkov.yaml \
          --directory src/ \
          --output json \
          --output-file-path security/reports/checkov-report.json \
          --output sarif \
          --output-file-path security/reports/checkov-sarif.json \
          --output junit \
          --output-file-path security/reports/checkov-junit.xml
          
    - name: Run TFSec Security Scan
      if: ${{ !inputs.skip_tfsec }}
      continue-on-error: true
      run: |
        tfsec src/ \
          --config-file security/sast-tools/.tfsec.yml \
          --format json \
          --out security/reports/tfsec-report.json \
          --format sarif \
          --out security/reports/tfsec-sarif.json \
          --format junit \
          --out security/reports/tfsec-junit.xml
          
    - name: Run Terrascan Security Scan
      if: ${{ !inputs.skip_terrascan }}
      continue-on-error: true
      run: |
        terrascan scan \
          --config-path security/sast-tools/.terrascan_config.toml \
          --iac-dir src/ \
          --output json \
          --output-dir security/reports/ \
          --output sarif \
          --output-dir security/reports/
          
    - name: Process Security Scan Results
      id: process_results
      run: |
        python3 << 'EOF'
        import json
        import os
        import sys
        from pathlib import Path
        
        def count_issues_by_severity(file_path, tool):
            """Count security issues by severity level"""
            if not os.path.exists(file_path):
                return {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
                
            try:
                with open(file_path, 'r') as f:
                    data = json.load(f)
                    
                counts = {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
                
                if tool == "checkov":
                    if "results" in data and "failed_checks" in data["results"]:
                        for check in data["results"]["failed_checks"]:
                            severity = check.get("severity", "").lower()
                            if severity in counts:
                                counts[severity] += 1
                                
                elif tool == "tfsec":
                    if "results" in data:
                        for result in data["results"]:
                            severity = result.get("severity", "").lower()
                            if severity in counts:
                                counts[severity] += 1
                                
                elif tool == "terrascan":
                    # Terrascan outputs to results.json
                    if "results" in data and "violations" in data["results"]:
                        for violation in data["results"]["violations"]:
                            severity = violation.get("severity", "").lower()
                            if severity in counts:
                                counts[severity] += 1
                                
                return counts
            except Exception as e:
                print(f"Error processing {tool} results: {e}")
                return {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
        
        # Process results from each tool
        tools = {
            "checkov": "security/reports/checkov-report.json",
            "tfsec": "security/reports/tfsec-report.json", 
            "terrascan": "security/reports/results.json"
        }
        
        total_counts = {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
        tool_results = {}
        
        for tool, file_path in tools.items():
            counts = count_issues_by_severity(file_path, tool)
            tool_results[tool] = counts
            
            for severity in total_counts:
                total_counts[severity] += counts[severity]
        
        # Create summary
        summary = {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "total_issues": sum(total_counts.values()),
            "by_severity": total_counts,
            "by_tool": tool_results
        }
        
        # Save unified report
        with open("security/reports/unified-scan-results.json", "w") as f:
            json.dump(summary, f, indent=2)
        
        # Set GitHub Actions outputs
        print(f"::set-output name=total_issues::{summary['total_issues']}")
        print(f"::set-output name=critical_issues::{total_counts['critical']}")
        print(f"::set-output name=high_issues::{total_counts['high']}")
        print(f"::set-output name=medium_issues::{total_counts['medium']}")
        print(f"::set-output name=low_issues::{total_counts['low']}")
        
        # Print summary
        print("\n=== Security Scan Summary ===")
        print(f"Total Issues: {summary['total_issues']}")
        print(f"Critical: {total_counts['critical']}")
        print(f"High: {total_counts['high']}")
        print(f"Medium: {total_counts['medium']}")
        print(f"Low: {total_counts['low']}")
        print(f"Info: {total_counts['info']}")
        
        # Determine if build should fail
        fail_on_high = "${{ inputs.fail_on_high }}" == "true"
        should_fail = total_counts['critical'] > 0 or (fail_on_high and total_counts['high'] > 0)
        
        if should_fail:
            print("\n‚ùå Security scan FAILED - Critical/High severity issues found!")
            sys.exit(1)
        elif summary['total_issues'] > 0:
            print("\n‚ö†Ô∏è  Security scan completed with warnings - Medium/Low severity issues found")
        else:
            print("\n‚úÖ Security scan PASSED - No issues found!")
        EOF
        
    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: security/reports/
        retention-days: 30
        
    - name: Upload SARIF results to GitHub Security
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: security/reports/
        
    - name: Comment PR - Security Scan Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let summary = "## üîí Security Scan Results\n\n";
          
          try {
            const results = JSON.parse(fs.readFileSync('security/reports/unified-scan-results.json', 'utf8'));
            
            summary += `**Total Issues Found:** ${results.total_issues}\n\n`;
            summary += "### Issues by Severity\n";
            summary += `- üî¥ Critical: ${results.by_severity.critical}\n`;
            summary += `- üü† High: ${results.by_severity.high}\n`;
            summary += `- üü° Medium: ${results.by_severity.medium}\n`;
            summary += `- üü¢ Low: ${results.by_severity.low}\n`;
            summary += `- ‚ÑπÔ∏è Info: ${results.by_severity.info}\n\n`;
            
            summary += "### Issues by Tool\n";
            for (const [tool, counts] of Object.entries(results.by_tool)) {
              const total = Object.values(counts).reduce((a, b) => a + b, 0);
              summary += `- **${tool.charAt(0).toUpperCase() + tool.slice(1)}**: ${total} issues\n`;
            }
            
            if (results.total_issues === 0) {
              summary += "\n‚úÖ **All security scans passed!**";
            } else if (results.by_severity.critical > 0 || results.by_severity.high > 0) {
              summary += "\n‚ùå **Security scan failed** - Critical or High severity issues found!";
            } else {
              summary += "\n‚ö†Ô∏è **Security scan completed with warnings** - Only Medium/Low severity issues found.";
            }
            
          } catch (error) {
            summary += "‚ùå Could not parse security scan results.";
          }
          
          summary += `\n\n*Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-validate, security-scan]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        
    - name: Terraform Init
      run: |
        cd src
        terraform init -backend=false
        
    - name: Terraform Plan
      id: plan
      run: |
        cd src
        terraform plan -no-color -out=tfplan
      continue-on-error: true
      
    - name: Comment PR - Terraform Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `#### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
          
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform\n
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })